# this is internal
server {
    listen  80 ;
    listen 443 ssl;
    server_name mobile.dev;

    access_log  /var/log/casumo_nginx main;

    ssl_certificate /etc/nginx/ssl-certificates/mobile.dev.crt;
    ssl_certificate_key /etc/nginx/ssl-certificates/mobile.dev.key;

    # Payments (resolver needed for payments upstream)
    resolver 192.168.50.88;
    set $payments_upstream "http://payments-reverse-proxy.at.casumotest.local:8080";

    root /var/www/mobile/mobile/build/www;

    location / {
        try_files $uri /index.html;
    }

    location ~ \.(xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|eot|tff)$ {
        try_files $uri =404;
    }

    location /static/ {
        proxy_pass http://mobile-react-stack:3000/static/;
    }

    location ~ ^/(.*)\.hot-update\.js$ {
        proxy_pass http://mobile-react-stack:3000/$1.hot-update.js;
        proxy_redirect  off;
    }

    location ~ ^/(.*)\.hot-update\.json$ {
        proxy_pass http://mobile-react-stack:3000/$1.hot-update.json;
        proxy_redirect  off;
    }

    location /sockjs-node/ {
        proxy_pass http://mobile-react-stack:3000/sockjs-node/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 7200000ms;
    }

    location /api-gw/ {
        proxy_pass http://api-gw:3101/;
        proxy_redirect  off;
    }

    # CometD
    location /cometd/ {
        proxy_pass http://common.dev/cometd/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 7200000ms;
    }

    # Common
    location /api/ {
        proxy_pass http://common.dev/api/;
    }

    # Registration
    location ^~ /utils/registration {
        proxy_pass http://logged-out-state-registration.dev/utils/registration/;
    }

    # GameBrowser
    location /api/gamebrowser/ {
        proxy_pass http://game-browser.dev/api/;
    }

    location /api/loginhistory/ {
        proxy_pass http://player-login-history.dev/;
    }

    location /api/compliance/ {
        proxy_pass http://compliance-gateway.dev/;
    }

    location ~ ^/paymentiq/api/([a-z]+)/(deposit|withdrawal)/process/$ {
        proxy_pass $payments_upstream/paymentiq/api/$1/$2/process/$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/([a-z]+)/deposit/redirect(.*)$ {
        proxy_pass $payments_upstream/paymentiq/api/$1/deposit/redirect$2$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/creditcard/deposit/callback$ {
        proxy_pass $payments_upstream/paymentiq/api/creditcard/deposit/callback$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/user/account/([0-9]+)/([0-9a-z\-]+)/(.*)$ {
        proxy_pass $payments_upstream/paymentiq/api/user/account/$1/$2/$3$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/paysafecard/deposit/finalize$ {
        proxy_pass $payments_upstream/paymentiq/api/paysafecard/deposit/finalize$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/entercash/redirect(.*)$ {
        proxy_pass $payments_upstream/paymentiq/api/entercash/redirect$1$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/worldpayhcg/callback$ {
        proxy_pass $payments_upstream/paymentiq/api/worldpayhcg/callback$is_args$args;
        proxy_redirect  off;
    }

    location ~ ^/paymentiq/api/pugglepay/deposit/process/auth(.*)$ {
        proxy_pass $payments_upstream/paymentiq/api/pugglepay/deposit/process/auth$1$is_args$args;
        proxy_redirect  off;
    }

    location /paymentiq/api/user/transaction {
        proxy_pass $payments_upstream/paymentiq/api/user/transaction;
        proxy_redirect  off;
    }

    location /paymentiq/api/user/account {
        proxy_pass $payments_upstream/paymentiq/api/user/account;
        proxy_redirect  off;
    }
}
